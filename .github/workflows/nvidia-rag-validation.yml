name: NVIDIA RAG System Validation (Following Quickstart Guide)

on:
  push:
    branches: [ main, 'dev-*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  PIPELINE_ID: ${{ github.run_id }}
  PIPELINE_NUMBER: ${{ github.run_number }}
  BRANCH_NAME: ${{ github.ref_name }}
  COMMIT_SHA: ${{ github.sha }}

jobs:
  # =============================================================================
  # SETUP: Initial environment and API key verification
  # =============================================================================
  setup:
    name: "ğŸ”§ Setup & NGC API Verification"
    runs-on: arc-runner-set-oke-org-poc
    environment: dev-nvidia-cloud-apis
    outputs:
      pipeline-id: ${{ env.PIPELINE_ID }}
    steps:
    - name: Install Git LFS
      run: |
        if ! command -v git-lfs &> /dev/null; then
          curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
          sudo apt-get install -y git-lfs
        fi
        git lfs version

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Initialize Git LFS
      run: |
        git lfs install
        git lfs pull

    - name: Verify NGC API Key
      env:
        NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
      run: |
        echo "ğŸ”‘ Verifying NGC API Key access..."
        if [ -z "$NGC_API_KEY" ]; then
          echo "âŒ NGC_API_KEY not found in environment secrets"
          exit 1
        fi
        
        response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $NGC_API_KEY" \
          "https://integrate.api.nvidia.com/v1/models" -o /tmp/api_test.json)
        
        if [ "$response" = "200" ]; then
          echo "âœ… NGC API connectivity verified"
          model_count=$(cat /tmp/api_test.json | jq '.data | length' 2>/dev/null || echo "0")
          echo "ğŸ“Š Available models: $model_count"
        else
          echo "âŒ NGC API connectivity failed (HTTP: $response)"
          exit 1
        fi
