apiVersion: testwave.nvidia.com/v1
kind: TestWorkflow
metadata:
  name: testwave-rag-notebook-github
  namespace: rag-ns
  annotations:
    testwave.nvidia.com/image-pull-secrets: nvcr.io
    description: "Execute RAG Blueprint notebook with nbclient and run comprehensive tests"
spec:
  taskSpec:
    steps:
    - name: execute-rag-notebook-and-test
      image: ghcr.io/ehfd/nvidia-dind:latest
      imagePullPolicy: Always
      securityContext:
        privileged: true
        runAsUser: 0
        runAsGroup: 0
      env:
        - name: DOCKER_TLS_CERTDIR
        - name: DOCKER_DRIVER
          value: overlay2
        - name: NVIDIA_VISIBLE_DEVICES
          value: all
        - name: NVIDIA_DRIVER_CAPABILITIES
          value: all
      script: |
        #!/bin/bash
        set -euo pipefail
        
        echo "========================================"
        echo "RAG Blueprint Notebook Execution Task"
        echo "========================================"
        echo ""
        
        # ==========================================
        # PHASE 1: Docker Daemon Setup
        # ==========================================
        echo "[PHASE 1] Starting Docker daemon with NVIDIA runtime..."
        dockerd \
          --host=unix:///var/run/docker.sock \
          --host=tcp://0.0.0.0:2375 \
          --storage-driver=overlay2 \
          --userland-proxy=false &
        
        echo "Waiting for Docker daemon..."
        timeout=120
        while ! docker info >/dev/null 2>&1; do
          sleep 2
          timeout=$((timeout-2))
          if [ $timeout -le 0 ]; then
            echo "ERROR: Docker daemon failed to start"
            exit 1
          fi
        done
        echo "SUCCESS: Docker daemon is ready"
        echo ""
        
        # ==========================================
        # PHASE 2: Navigate to Cloned Repository
        # ==========================================
        # TestWave automatically clones the repository
        # We need to navigate to it
        echo "[PHASE 2] Navigating to cloned repository..."
        cd /workspace/rag
        echo "Current directory: $(pwd)"
        echo ""
        
        # Clone blueprint-github-test repository (private)
        echo "Cloning blueprint-github-test (private)..."
        cd /workspace
        if [ -d "blueprint-github-test" ]; then
          rm -rf blueprint-github-test
        fi
        git clone --depth 1 https://oauth2:${BLUEPRINT_GITHUB_TEST_TOKEN}@github.com/NVIDIA-AI-Blueprints/blueprint-github-test.git
        echo "SUCCESS: blueprint-github-test repository cloned"
        echo ""
        
        # Return to rag directory
        cd /workspace/rag
        
        # ==========================================
        # PHASE 3: Environment Setup
        # ==========================================
        echo "[PHASE 3] Setting up environment..."
        
        # Verify NGC API Key
        if [ -z "${NGC_CLI_API_KEY:-}" ]; then
          echo "ERROR: NGC_CLI_API_KEY is not set"
          exit 1
        fi
        echo "SUCCESS: NGC_CLI_API_KEY is set"
        
        # Export as NGC_API_KEY for consistency with notebook
        export NGC_API_KEY="${NGC_CLI_API_KEY}"
        
        # Login to NVIDIA Container Registry
        echo "Logging into NVIDIA Container Registry..."
        echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
        echo "SUCCESS: Docker login successful"
        
        # Setup model cache directory
        mkdir -p ~/.cache/model-cache
        export MODEL_DIRECTORY=~/.cache/model-cache
        echo "SUCCESS: Model cache directory: $MODEL_DIRECTORY"
        
        # Install system dependencies
        echo "Installing system dependencies..."
        apt-get update -qq
        apt-get install -y python3 python3-pip python3-venv curl jq > /dev/null 2>&1
        echo "SUCCESS: System dependencies installed"
        echo ""
        
        # ==========================================
        # PHASE 4: Test Image Pull (Debug Phase)
        # ==========================================
        echo "[PHASE 4] Testing test image pull capability..."
        echo "Image: nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest"
        echo ""
        
        # Try to pull the test image
        if ! docker pull nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest 2>&1; then
          echo ""
          echo "=========================================="
          echo "ERROR: Failed to pull test image"
          echo "=========================================="
          echo ""
          echo "Root cause:"
          echo "  - NGC API Key may lack access to private registry 'rw983xdqtcdp'"
          echo "  - This is a private NVIDIA internal registry"
          echo ""
          echo "Impact:"
          echo "  - Notebook execution will work normally"
          echo "  - But pytest tests cannot run without this image"
          echo ""
          echo "Solution options:"
          echo "  1. Update NGC API Key with registry access"
          echo "  2. Use a different test image that is accessible"
          echo "  3. Skip testing phase (current task will exit here)"
          echo ""
          echo "Exiting early to avoid wasting resources..."
          exit 1
        fi
        
        echo "SUCCESS: Test image pulled successfully"
        echo "Test image is available for pytest execution"
        echo ""
        
        # ==========================================
        # PHASE 5: Download notebook_runner_nbclient.py
        # ==========================================
        echo "[PHASE 5] Downloading notebook_runner_nbclient.py..."
        cd /workspace/blueprint-github-test
        
        # Copy notebook runner from cloned repository
        if [ -f "utils/notebook_runner/notebook_runner_nbclient.py" ]; then
          cp utils/notebook_runner/notebook_runner_nbclient.py /workspace/rag/notebook_runner_nbclient.py
          chmod +x /workspace/rag/notebook_runner_nbclient.py
          echo "SUCCESS: notebook_runner_nbclient.py copied"
        else
          echo "ERROR: notebook_runner_nbclient.py not found in blueprint-github-test"
          exit 1
        fi
        echo ""
        
        # ==========================================
        # PHASE 6: Install Python Dependencies
        # ==========================================
        echo "[PHASE 6] Installing Python dependencies..."
        cd /workspace/rag
        
        # Create virtual environment (best practice)
        echo "Creating Python virtual environment..."
        python3 -m venv /tmp/notebook_venv
        
        # Activate virtual environment
        source /tmp/notebook_venv/bin/activate
        
        # Install dependencies in virtual environment
        pip install --quiet --upgrade pip
        pip install --quiet nbclient jupyter requests
        
        # Pre-install notebook dependencies to avoid kernel restart
        pip install --quiet python-dotenv aiohttp
        
        echo "SUCCESS: Python dependencies installed in virtual environment"
        echo "Virtual environment: /tmp/notebook_venv"
        echo ""
        
        # ==========================================
        # PHASE 7: Prepare Notebook
        # ==========================================
        echo "[PHASE 7] Preparing notebook for execution..."
        
        # Get git commit SHA for unique file naming
        COMMIT_SHA=$(git rev-parse --short=7 HEAD)
        export COMMIT_SHA  # Export for Python script
        echo "Commit SHA: $COMMIT_SHA"
        
        # Create temporary notebook copy and add ci-skip tag
        NOTEBOOK_PATH="notebooks/launchable.ipynb"
        TEMP_NOTEBOOK="notebooks/launchable.${COMMIT_SHA}.ipynb"
        
        cp "$NOTEBOOK_PATH" "$TEMP_NOTEBOOK"
        echo "SUCCESS: Created temporary notebook: $TEMP_NOTEBOOK"
        
        # Add ci-skip tag to kernel restart cell
        /tmp/notebook_venv/bin/python << 'EOF'
        import json
        import os
        
        commit_sha = os.environ['COMMIT_SHA']
        notebook_path = f"notebooks/launchable.{commit_sha}.ipynb"
        
        with open(notebook_path, 'r', encoding='utf-8') as f:
            nb = json.load(f)
        
        # Find and tag kernel restart cell
        for i, cell in enumerate(nb['cells']):
            if cell['cell_type'] == 'code':
                source = ''.join(cell.get('source', []))
                if 'do_shutdown' in source or 'kernel.do_shutdown' in source:
                    if 'metadata' not in cell:
                        cell['metadata'] = {}
                    if 'tags' not in cell['metadata']:
                        cell['metadata']['tags'] = []
                    if 'ci-skip' not in cell['metadata']['tags']:
                        cell['metadata']['tags'].append('ci-skip')
                    print(f"SUCCESS: Added ci-skip tag to cell {i+1}")
                    break
        
        with open(notebook_path, 'w', encoding='utf-8') as f:
            json.dump(nb, f, indent=1, ensure_ascii=False)
        EOF
        
        echo "SUCCESS: Notebook prepared with ci-skip tag"
        echo ""
        
        # ==========================================
        # PHASE 8: Setup RAG Environment
        # ==========================================
        echo "[PHASE 8] Setting up RAG environment variables..."
        
        # Append environment variables to .env file
        cat >> deploy/compose/.env << 'ENVEOF'
        export APP_LLM_SERVERURL=""
        export SUMMARY_LLM_SERVERURL=""
        export APP_EMBEDDING_SERVERURL=""
        export APP_RANKING_SERVERURL=""
        ENVEOF
        
        # Source environment file
        source deploy/compose/.env
        echo "SUCCESS: Environment variables configured"
        
        # Set USERID for Docker Compose
        export USERID=$(id -u)
        echo "SUCCESS: USERID set to $USERID"
        echo ""
        
        # ==========================================
        # PHASE 9: Execute Notebook with Monitoring
        # ==========================================
        echo "[PHASE 9] Executing notebook with intelligent service waiting..."
        echo "Notebook: $TEMP_NOTEBOOK"
        echo ""
        
        # Create output directory
        mkdir -p notebook_output
        
        # Activate virtual environment for notebook execution
        source /tmp/notebook_venv/bin/activate
        
        # Start notebook execution in background with output logging
        python notebook_runner_nbclient.py \
          -f "$TEMP_NOTEBOOK" \
          --output-dir notebook_output \
          --skip-tags ci-skip \
          -e "NGC_API_KEY=${NGC_API_KEY}" \
          > notebook_execution.log 2>&1 &
        
        NOTEBOOK_PID=$!
        echo "Notebook runner started with PID: $NOTEBOOK_PID"
        
        # Monitor with tail in background and fast polling
        echo "Monitoring notebook output for RAG server startup..."
        echo ""
        
        # Start tail for display
        tail -f notebook_execution.log &
        TAIL_PID=$!
        
        # Simple fast polling
        RAG_STARTED=false
        
        while kill -0 $NOTEBOOK_PID 2>/dev/null; do
          if ! $RAG_STARTED && grep -q "Starting RAG microservices" notebook_execution.log; then
            echo ""
            echo "[WORKFLOW] Detected RAG services starting, pausing notebook..."
            
            # Pause immediately
            if kill -STOP $NOTEBOOK_PID 2>/dev/null; then
              RAG_STARTED=true
              echo "[WORKFLOW] Notebook paused"
              echo ""
            else
              echo "[WORKFLOW] ERROR: Failed to pause"
              kill $TAIL_PID 2>/dev/null
              exit 1
            fi
            
            # Wait for services to be ready
            echo "[WORKFLOW] Phase 1: Initial delay (30s)..."
            sleep 30
            echo ""
            
            echo "[WORKFLOW] Phase 2: Health check..."
            max_attempts=30
            attempt=0
            health_ready=false
            
            while [ $attempt -lt $max_attempts ]; do
              attempt=$((attempt + 1))
              
              if curl -sf -m 5 http://0.0.0.0:8081/v1/health 2>/dev/null | grep -q "Service is up"; then
                echo "[WORKFLOW] Health OK (attempt $attempt)"
                health_ready=true
                break
              fi
              
              [ $((attempt % 5)) -eq 0 ] && echo "[WORKFLOW] Waiting... ($attempt/$max_attempts)"
              sleep 2
            done
            
            # Additional wait for full initialization
            if [ "$health_ready" = true ]; then
              echo "[WORKFLOW] Phase 3: Final wait (30s)..."
              sleep 30
              echo "[WORKFLOW] SUCCESS: Ready (~$((60 + attempt * 2))s total)"
            else
              echo "[WORKFLOW] WARNING: Timeout, continuing"
            fi
            
            # Resume notebook
            echo ""
            echo "[WORKFLOW] Resuming notebook..."
            if kill -CONT $NOTEBOOK_PID 2>/dev/null; then
              echo "[WORKFLOW] SUCCESS: Resumed"
            else
              echo "[WORKFLOW] ERROR: Resume failed"
            fi
            echo ""
            break
          fi
          
          # Fast polling - 0.2 second
          sleep 0.2
        done
        
        # Cleanup
        kill $TAIL_PID 2>/dev/null || true
        
        # Wait for notebook to complete
        wait $NOTEBOOK_PID
        NOTEBOOK_EXIT=$?
        
        echo ""
        echo "=========================================="
        if [ $NOTEBOOK_EXIT -eq 0 ]; then
          echo "SUCCESS: Notebook execution completed successfully"
        else
          echo "ERROR: Notebook execution failed (exit code: $NOTEBOOK_EXIT)"
          
          # Show last 50 lines of log for debugging
          echo ""
          echo "Last 50 lines of notebook execution log:"
          tail -50 notebook_execution.log
          exit 1
        fi
        echo "=========================================="
        echo ""
        
        # ==========================================
        # PHASE 10: Wait for RAG Playground Ready
        # ==========================================
        echo "[PHASE 10] Waiting for RAG Playground (Frontend) to be ready..."
        echo ""
        echo "=========================================="
        echo "Initial Diagnostics"
        echo "=========================================="
        
        # Check if container exists and its status
        echo "[DEBUG] Checking if rag-frontend container exists..."
        if docker ps -a --filter "name=rag-frontend" --format "{{.Names}}" | grep -q "rag-frontend"; then
          CONTAINER_STATUS=$(docker ps -a --filter "name=rag-frontend" --format "{{.Status}}")
          echo "[DEBUG] Container found: $CONTAINER_STATUS"
          
          # Get container ID
          CONTAINER_ID=$(docker ps -a --filter "name=rag-frontend" --format "{{.ID}}")
          echo "[DEBUG] Container ID: $CONTAINER_ID"
          
          # Check if container is running
          if docker ps --filter "name=rag-frontend" --format "{{.Names}}" | grep -q "rag-frontend"; then
            echo "[DEBUG] ✓ Container is running"
          else
            echo "[DEBUG] ✗ Container is NOT running"
            echo "[DEBUG] Container state:"
            docker inspect rag-frontend --format '{{.State.Status}}: {{.State.Error}}' 2>&1
          fi
        else
          echo "[DEBUG] ✗ Container not found!"
          echo "[DEBUG] All containers:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}"
        fi
        echo ""
        
        # Check network connectivity
        echo "[DEBUG] Checking Docker network connectivity..."
        if docker network inspect nvidia-rag >/dev/null 2>&1; then
          echo "[DEBUG] ✓ nvidia-rag network exists"
          echo "[DEBUG] Containers on nvidia-rag network:"
          docker network inspect nvidia-rag --format '{{range .Containers}}  - {{.Name}} ({{.IPv4Address}}){{println}}{{end}}' 2>&1
          
          # Check if rag-frontend is on the network
          if docker network inspect nvidia-rag --format '{{range .Containers}}{{.Name}}{{end}}' | grep -q "rag-frontend"; then
            echo "[DEBUG] ✓ rag-frontend is connected to nvidia-rag network"
            RAG_FRONTEND_IP=$(docker network inspect nvidia-rag --format '{{range .Containers}}{{if eq .Name "rag-frontend"}}{{.IPv4Address}}{{end}}{{end}}')
            echo "[DEBUG] rag-frontend IP: $RAG_FRONTEND_IP"
          else
            echo "[DEBUG] ✗ rag-frontend is NOT on nvidia-rag network!"
          fi
        else
          echo "[DEBUG] ✗ nvidia-rag network does not exist!"
        fi
        echo ""
        
        # Check Docker DNS resolution
        echo "[DEBUG] Testing Docker DNS resolution..."
        docker run --rm --network nvidia-rag alpine:latest nslookup rag-frontend 2>&1 | head -10 || echo "[DEBUG] DNS test failed"
        echo ""
        
        echo "=========================================="
        echo "Starting Connection Attempts"
        echo "=========================================="
        echo "Target: http://rag-frontend:3000"
        echo "Max attempts: 150 (~5 minutes)"
        echo ""
        
        max_attempts=150
        attempt=0
        playground_ready=false
        last_error=""
        
        while [ $attempt -lt $max_attempts ]; do
          attempt=$((attempt + 1))
          
          # Try to connect to the frontend from within Docker network
          # Use alpine container with curl to test connectivity from inside the network
          curl_output=$(docker run --rm --network nvidia-rag alpine:latest sh -c "wget -q -O- -T 5 http://rag-frontend:3000 2>&1" 2>&1)
          curl_exit=$?
          
          if [ $curl_exit -eq 0 ]; then
            echo ""
            echo "=========================================="
            echo "SUCCESS: RAG Playground is ready!"
            echo "=========================================="
            echo "Attempts: $attempt/$max_attempts"
            echo "Time elapsed: ~$((attempt * 2))s"
            echo ""
            playground_ready=true
            break
          else
            # Capture error for debugging
            last_error="$curl_output"
          fi
          
          # Show detailed progress every 10 attempts
          if [ $((attempt % 10)) -eq 0 ]; then
            echo "[Attempt $attempt/$max_attempts] Still waiting... (~$((attempt * 2))s elapsed)"
            
            # Show container status
            CURRENT_STATUS=$(docker ps --filter "name=rag-frontend" --format "{{.Status}}" 2>&1)
            if [ -n "$CURRENT_STATUS" ]; then
              echo "  Container status: $CURRENT_STATUS"
            else
              echo "  Container status: NOT RUNNING or NOT FOUND"
            fi
            
            # Show last curl error (truncate if too long)
            if [ -n "$last_error" ]; then
              ERROR_PREVIEW=$(echo "$last_error" | head -c 200)
              echo "  Last error: $ERROR_PREVIEW"
            fi
            
            # Show container health (if available)
            HEALTH=$(docker inspect rag-frontend --format '{{.State.Health.Status}}' 2>/dev/null)
            if [ -n "$HEALTH" ] && [ "$HEALTH" != "<no value>" ]; then
              echo "  Health: $HEALTH"
            fi
            
            # Show container logs (last 5 lines) every 30 attempts
            if [ $((attempt % 30)) -eq 0 ]; then
              echo "  Container logs (last 5 lines):"
              docker logs rag-frontend --tail 5 2>&1 | sed 's/^/    /'
            fi
          fi
          
          sleep 2
        done
        
        if [ "$playground_ready" = false ]; then
          echo ""
          echo "=========================================="
          echo "WARNING: RAG Playground Connection Timeout"
          echo "=========================================="
          echo "Timeout: ~$((max_attempts * 2))s (~5 minutes)"
          echo "This may be expected - frontend can take time to build/start"
          echo "UI tests may be skipped or fail"
          echo ""
          
          echo "=== Final Diagnostics ==="
          echo ""
          echo "1. All containers status:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          
          echo "2. rag-frontend specific details:"
          docker inspect rag-frontend --format 'Container: {{.Name}} | State: {{.State.Status}} | Error: {{.State.Error}} | Started: {{.State.StartedAt}} | Exit Code: {{.State.ExitCode}} | Restart Count: {{.RestartCount}}' 2>&1 || echo "Could not inspect container"
          echo ""
          
          echo "3. rag-frontend logs (last 50 lines):"
          docker logs rag-frontend --tail 50 2>&1 || echo "Could not fetch logs"
          echo ""
          
          echo "4. Network connectivity test from alpine container:"
          docker run --rm --network nvidia-rag alpine:latest wget -O- -T 5 http://rag-frontend:3000 2>&1 | head -20 || echo "Network test failed"
          echo ""
          
          echo "5. Port check (is 3000 listening?):"
          docker exec rag-frontend netstat -tuln 2>/dev/null | grep 3000 || echo "netstat not available or port not listening"
          echo ""
          
          echo "=========================================="
        fi
        echo ""
        
        # ==========================================
        # PHASE 11: Cleanup Temporary Notebook
        # ==========================================
        echo "[PHASE 11] Cleaning up temporary notebook..."
        
        if [ -f "$TEMP_NOTEBOOK" ]; then
          rm -f "$TEMP_NOTEBOOK"
          echo "SUCCESS: Temporary notebook removed: $TEMP_NOTEBOOK"
        fi
        echo ""
        
        # ==========================================
        # PHASE 12: Run Tests - Notebook Markers
        # ==========================================
        echo "[PHASE 12] Running pytest tests - Notebook markers..."
        echo "Test markers: rag and notebook"
        echo ""
        
        # Re-login to NGC for pulling test image
        echo "Re-authenticating with NGC for test image..."
        if ! echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin 2>&1 | grep -q "Login Succeeded"; then
          echo "WARNING: NGC login may have failed, but continuing..."
        fi
        
        # Pre-pull test image to avoid timeout during docker run
        echo "Pulling test image: nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest"
        if ! docker pull nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest; then
          echo ""
          echo "ERROR: Failed to pull test image from NGC"
          echo "This may be due to:"
          echo "  1. NGC API Key lacks access to this private registry"
          echo "  2. Image path or tag is incorrect"
          echo "  3. Network connectivity issues"
          echo ""
          echo "The notebook executed successfully, but tests cannot run without the test image."
          echo "Consider using a publicly accessible test image or updating NGC permissions."
          echo ""
          echo "Execution status: Notebook completed successfully"
          echo "Test status: Skipped due to image pull failure"
          exit 0
        fi
        echo "SUCCESS: Test image pulled successfully"
        echo ""
        
        OUTPUT_HTML="notebook_output/launchable.${COMMIT_SHA}.html"
        
        # Verify HTML output exists
        if [ ! -f "$OUTPUT_HTML" ]; then
          echo "ERROR: Expected HTML output not found: $OUTPUT_HTML"
          echo "Contents of notebook_output/:"
          ls -la notebook_output/
          exit 1
        fi
        echo "SUCCESS: Found generated HTML: $OUTPUT_HTML"
        
        # Run notebook tests
        docker run --rm --network nvidia-rag \
          -v "$(pwd)/$OUTPUT_HTML:/app/input/rag_2_3_launchable.html" \
          -v "/workspace:/workspace" \
          nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest \
          pytest -m "rag and notebook" \
            --rag-playground-url="http://rag-frontend:3000" \
            --api-url="http://rag-server:8081" \
            --disable-warnings \
            --self-contained-html \
            --html=/workspace/rag_${COMMIT_SHA}_test_report_notebook.html
        
        notebook_test_result=$?
        
        if [ $notebook_test_result -eq 0 ]; then
          echo "SUCCESS: Notebook tests passed"
        else
          echo "WARNING: Some notebook tests failed (exit code: $notebook_test_result)"
        fi
        echo ""
        
        # ==========================================
        # PHASE 13: Run Tests - UI Markers
        # ==========================================
        echo "[PHASE 13] Running pytest tests - UI markers..."
        echo "Test markers: rag and ui"
        echo ""
        
        # Ensure NGC authentication is still valid
        echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin > /dev/null 2>&1
        
        # Run UI tests
        docker run --rm --network nvidia-rag \
          -v "$(pwd)/$OUTPUT_HTML:/app/input/rag_2_3_launchable.html" \
          -v "/workspace:/workspace" \
          nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest \
          pytest -m "rag and ui" \
            --rag-playground-url="http://rag-frontend:3000" \
            --api-url="http://rag-server:8081" \
            --disable-warnings \
            --self-contained-html \
            --html=/workspace/rag_${COMMIT_SHA}_test_report_ui.html
        
        ui_test_result=$?
        
        if [ $ui_test_result -eq 0 ]; then
          echo "SUCCESS: UI tests passed"
        else
          echo "WARNING: Some UI tests failed (exit code: $ui_test_result)"
        fi
        echo ""
        
        # ==========================================
        # PHASE 14: Final Summary
        # ==========================================
        echo "=========================================="
        echo "Execution Summary"
        echo "=========================================="
        echo "Notebook: Executed successfully"
        echo "Generated HTML: /workspace/rag/$OUTPUT_HTML"
        echo "Notebook Test Report: /workspace/rag_${COMMIT_SHA}_test_report_notebook.html"
        echo "UI Test Report: /workspace/rag_${COMMIT_SHA}_test_report_ui.html"
        echo ""
        
        # Determine overall test status
        if [ $notebook_test_result -eq 0 ] && [ $ui_test_result -eq 0 ]; then
          echo "SUCCESS: All tests passed!"
          test_exit=0
        else
          echo "WARNING: Some tests failed"
          echo "  Notebook tests: exit code $notebook_test_result"
          echo "  UI tests: exit code $ui_test_result"
          test_exit=1
        fi
        
        echo "=========================================="
        echo "SUCCESS: RAG Blueprint Notebook Task Completed"
        echo "=========================================="
        
        # Exit with test result
        exit $test_exit
      
      resources:
        limits:
          nvidia.com/gpu: "1"
          memory: "32Gi"
          cpu: "8"
        requests:
          nvidia.com/gpu: "1"
          memory: "16Gi"
          cpu: "4"
    
    workspaces:
      - name: shared-workspace
        description: Shared workspace for repository and outputs
        mountPath: /workspace
      - name: artifacts
        description: TestWave artifacts storage for test reports and outputs
        mountPath: /artifacts
  
  # Trigger configuration - monitors GitHub repository
  trigger:
    type: git
    git:
      type: github
      uri: https://github.com/bp-cicd-org/rag
      branch: main
      secretRef: blueprint-github-test-token
  
  # TaskRun specification - runtime configuration
  taskRunSpec:
    timeout: "10h0m0s"
    workspaces:
    - name: shared-workspace
      persistentVolumeClaim:
        claimName: rag-workspace
    
    # Environment variables from secrets
    podTemplate:
      env:
        - name: NGC_CLI_API_KEY
          valueFrom:
            secretKeyRef:
              name: ngc-api-key
              key: token
        - name: BLUEPRINT_GITHUB_TEST_TOKEN
          valueFrom:
            secretKeyRef:
              name: blueprint-github-test-token
              key: token

